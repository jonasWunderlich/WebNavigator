// Generated by CoffeeScript 1.6.2
(function() {
  var block, blockStyle, blockSum, blocks, idToRef, lastUrl, lastVid, loadHistory, logInfo, processHistoryItems, processVisitItems, processed, siteHistory, tabconnections, visitIdAufSID;

  processed = 0;

  tabconnections = [];

  block = 0;

  lastVid = 0;

  lastUrl = "";

  siteHistory = [];

  visitIdAufSID = [];

  blockSum = 0;

  blocks = {};

  blockStyle = [];

  idToRef = {};

  loadHistory = function(callbackFn) {
    block = 0;
    lastVid = 0;
    lastUrl = "";
    siteHistory = [];
    visitIdAufSID = [];
    blockSum = 0;
    idToRef = {};
    blocks = {};
    blockStyle = [];
    return chrome.storage.local.get("tabConnections", function(result) {
      if (result.tabConnections) {
        tabconnections = result.tabConnections;
      } else {
        tabconnections = [];
      }
      return processHistoryItems(callbackFn);
    });
  };

  processHistoryItems = function(callbackFn) {
    var date, daydate, endtime, microsecondsPerDay, starttime, time;

    console.log(filter);
    time = filter.time;
    processed = 0;
    date = new Date();
    daydate = date.getTime() - ((((date.getHours() + 1) * 60 + date.getMinutes()) * 60 + date.getSeconds()) * 1000);
    microsecondsPerDay = 1000 * 60 * 60 * 24;
    endtime = daydate - (microsecondsPerDay * (time - 1));
    starttime = daydate - (microsecondsPerDay * (30 + time));
    return chrome.history.search({
      text: filter.query,
      startTime: starttime,
      endTime: endtime,
      maxResults: filter.results
    }, function(historyItems) {
      console.log(historyItems.length);
      return (historyItems.reverse()).forEach(function(site) {
        processed++;
        return chrome.history.getVisits({
          url: site.url
        }, function(visitItems) {
          return processVisitItems(site, visitItems, callbackFn);
        });
      });
    });
  };

  processVisitItems = function(site, visitItems, callbackFn) {
    var bookmark, context, count, i, id, ref, referrer, siteItem, tab, time, type, vid, vids, _i, _len;

    referrer = vids = [];
    id = site.id;
    vid = visitItems[visitItems.length - 1].visitId;
    ref = visitItems[visitItems.length - 1].referringVisitId;
    type = visitItems[visitItems.length - 1].transition;
    time = visitItems[visitItems.length - 1].visitTime;
    count = site.visitCount;
    for (_i = 0, _len = visitItems.length; _i < _len; _i++) {
      i = visitItems[_i];
      if (i.visitId > vid - 300) {
        if (tabconnections[i.visitId] != null) {
          referrer.push(tabconnections[+i.visitId]);
        }
        if (i.referringVisitId !== "0") {
          referrer.push(i.referringVisitId);
        }
        visitIdAufSID[i.visitId] = id;
      }
    }
    idToRef[id] = referrer;
    if (type === "link" && (lastVid === ref || lastUrl === site.url.substr(0, 10))) {
      null;
    } else {
      block++;
    }
    lastVid = vid;
    lastUrl = site.url.substr(0, 10);
    context = "";
    bookmark = void 0;
    if (bookMarks[site.url] != null) {
      context = bookMarks[site.url].context;
      bookmark = bookMarks[site.url].bid;
    }
    tab = tabArray[site.url] != null ? tabArray[site.url] : "";
    siteItem = {
      sid: id,
      vid: vid,
      url: site.url,
      title: site.title,
      type: type,
      ref: ref,
      relevance: count,
      time: time,
      block: block,
      context: context,
      tab: tab,
      bid: bookmark
    };
    siteHistory[id] = siteItem;
    processed--;
    if (processed === 0) {
      blockSum = block;
      return callbackFn();
    }
  };

  logInfo = function(infoarray) {
    var i, info, k, siteinfo;

    siteinfo = $("<div>");
    for (k in infoarray) {
      i = infoarray[k];
      info = $("<div>");
      info.text(i);
      info.addClass("infotext");
      if (k === "0") {
        info.addClass("title");
      }
      siteinfo.append($(info));
    }
    return $("#historycontent").append($(siteinfo));
  };

  /*
  createBlocks = () ->
    block = 1
    for id,val of siteHistory
      processed++
      for v in idToRef[id]
        processed++
        if visitIdAufSID[v]?
          if siteHistory[visitIdAufSID[v]].block != 0 #block wird geerbt
            if val.block != 0
              for s in siteHistory # noch berÃ¼cksichtigen dass andere mitgenommen werden
                if s.block == val.block then s.block = siteHistory[visitIdAufSID[v]].block
            val.block = siteHistory[visitIdAufSID[v]].block
          else
            if val.block == 0
              siteHistory[visitIdAufSID[v]].block = val.block = block #gibt nix zu erben man braucht einen neuen
              block++
            else
              siteHistory[visitIdAufSID[v]].block = val.block #gibt nix & man hat schon -> in die andere richtung vererben
        processed--
      if val.block is 0 or idToRef[id].length is 0
        val.block = block
        block++
      processed--
    if processed is 0
      for k,i of siteHistory
        logInfo([i.title.substr(0,40), i.sid, i.vid, i.ref, i.type, i.block])
  */


}).call(this);
